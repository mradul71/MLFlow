<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Intelligent ML Experiment Tracking</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</head>
<body>
    <!-- Navigation Header -->
    <header class="header">
        <div class="nav-container">
            <div class="nav-brand">
                <!-- <h1>Enhanced MLflow</h1> -->
            </div>
            <nav class="nav-menu">
                <!-- <button class="nav-link active" data-view="dashboard">Dashboard</button> -->
                <button class="nav-link" data-view="experiments">Experiments</button>
                <button class="nav-link" data-view="shap">SHAP Analysis</button>
                <button class="nav-link" data-view="architecture">System Architecture</button>
                <button class="nav-link" data-view="models">Models</button>
            </nav>
            <div class="nav-user">
                <span class="user-greeting">Welcome, Ryan</span>
            </div>
        </div>
    </header>

    <main class="main-content">
        <!-- SHAP Analysis View -->
         <p id="main-heading-web" style="text-align: center;">Custom Dashboard for Machine Learning Model Experiment Tracking and Explainability</p>
        <div id="shap-view" class="view">
            <div class="page-header">
                <h2>üîç SHAP Analysis Dashboard</h2>
                <p class="page-subtitle">Model explainability and feature interpretation using SHAP values</p>
            </div>

            <div class="shap-content">
                <!-- Data Upload Section -->
                <div class="card shap-upload-card">
                    <div class="card__body">
                        <h3>üìÅ Sample Data Upload</h3>
                        <div class="file-upload-area" id="file-upload-area">
                            <div class="upload-icon">üì§</div>
                            <div class="upload-text">
                                <p class="upload-title">Upload CSV file for SHAP analysis</p>
                                <p class="upload-subtitle">Drag and drop your file here or click to browse</p>
                            </div>
                            <input type="file" id="file-input" accept=".csv" class="file-input hidden">
                        </div>
                        
                        <div id="data-preview" class="data-preview hidden">
                            <h4>Data Preview</h4>
                            <div class="table-container">
                                <table class="data-preview-table" id="data-preview-table">
                                    <!-- Will be populated by JavaScript -->
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- SHAP Visualizations -->
                <div class="shap-visualizations" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <!-- Left Column: Summary Plot (Full Height) -->
                    <div class="card" style="height: 100%;">
                        <div class="card__body" style="height: 100%; display: flex; flex-direction: column;">
                            <h3>üéØ SHAP Summary Plot</h3>
                            <div class="chart-container" style="position: relative; flex: 1; min-height: 820px;">
                                <canvas id="shap-summary-chart"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Right Column: decision Plot + Bar Chart Stacked -->
                    <div style="display: flex; flex-direction: column; gap: 20px; height: 100%;">
                        <div class="card" style="flex: 1;">
                            <div class="card__body" style="height: 100%; display: flex; flex-direction: column;">
                                <h3>üíß SHAP Decision Plot</h3>
                                <div class="chart-container" style="position: relative; flex: 1; min-height: 400px;">
                                    <canvas id="shap-decision-chart"></canvas>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card" style="flex: 1;">
                            <div class="card__body" style="height: 100%; display: flex; flex-direction: column;">
                                <h3>üìä SHAP Bar Chart</h3>
                                <div class="chart-container" style="position: relative; flex: 1; min-height: 400px;">
                                    <canvas id="shap-bar-chart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card__body">
                        <h3>üíß SHAP Force Plot</h3>
                        <div class="chart-container" style="position: relative; flex: 1; min-height: 100px;">
                            <canvas id="shap-force-chart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- SHAP Values Table -->
                <div class="card">
                    <div class="card__body">
                        <h3>üìã SHAP Values Details</h3>
                        <div class="table-container">
                            <table class="shap-values-table" id="shap-values-table">
                                <thead>
                                    <tr>
                                        <th>Feature</th>
                                        <th>SHAP Value</th>
                                        <th>Feature Value</th>
                                        <th>Contribution</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

       <!-- System Architecture View -->
        <div id="architecture-view" class="view">
            <div class="page-header">
                <h2>üèóÔ∏è System Architecture</h2>
                <p class="page-subtitle">MLflow-based ML experiment tracking with enhanced explainability</p>
            </div>

            <div class="architecture-content">
                <!-- Architecture Overview -->
                <div class="card architecture-overview">
                    <div class="card__body">
                        <h3>Architecture Overview</h3>
                        <p class="architecture-description">
                            This system integrates a local MLflow tracking server (localhost:8080) with an enhanced web interface 
                            for comprehensive experiment tracking, SHAP-based model explainability, and advanced visualization capabilities.
                        </p>
                        <div class="architecture-diagram" id="architecture-diagram">
                            <!-- Will be populated by JavaScript -->
                        </div>
                    </div>
                </div>

                <!-- Detailed Workflow -->
                <div class="card" style="margin-top: var(--space-24);">
                    <div class="card__body">
                        <h3>üîÑ ML Experiment Workflow</h3>
                        <div style="padding: var(--space-16); background: var(--color-background-secondary); border-radius: 8px;">
                            <div style="display: flex; flex-direction: column; gap: var(--space-16);">
                                <div style="display: flex; align-items: start; gap: var(--space-12);">
                                    <div style="flex: 0 0 40px; height: 40px; background: #1FB8CD; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">1</div>
                                    <div style="flex: 1;">
                                        <h4 style="margin: 0 0 8px 0;">Model Training & Logging</h4>
                                        <p style="margin: 0; color: var(--color-text-secondary);">ML models are trained locally and logged to MLflow tracking server. Parameters, metrics (accuracy, precision, recall, F1, AUC-ROC), and artifacts (model files, confusion matrices, SHAP CSVs) are automatically tracked.</p>
                                    </div>
                                </div>
                                
                                <div style="display: flex; align-items: start; gap: var(--space-12);">
                                    <div style="flex: 0 0 40px; height: 40px; background: #FFC185; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">2</div>
                                    <div style="flex: 1;">
                                        <h4 style="margin: 0 0 8px 0;">MLflow API Communication</h4>
                                        <p style="margin: 0; color: var(--color-text-secondary);">Web interface fetches experiment data via MLflow REST API (/api/2.0/mlflow/*). Retrieves experiments, runs, metrics, parameters, and artifact listings through standardized endpoints.</p>
                                    </div>
                                </div>
                                
                                <div style="display: flex; align-items: start; gap: var(--space-12);">
                                    <div style="flex: 0 0 40px; height: 40px; background: #B4413C; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">3</div>
                                    <div style="flex: 1;">
                                        <h4 style="margin: 0 0 8px 0;">Artifact Processing</h4>
                                        <p style="margin: 0; color: var(--color-text-secondary);">System automatically discovers and fetches CSV artifacts containing SHAP values. Uses proxy endpoint (/artifact-content) to retrieve artifact data, searching up to 3 directory levels deep.</p>
                                    </div>
                                </div>
                                
                                <div style="display: flex; align-items: start; gap: var(--space-12);">
                                    <div style="flex: 0 0 40px; height: 40px; background: #5D878F; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">4</div>
                                    <div style="flex: 1;">
                                        <h4 style="margin: 0 0 8px 0;">SHAP Analysis & Visualization</h4>
                                        <p style="margin: 0; color: var(--color-text-secondary);">Parses SHAP CSV data using PapaParse library. Generates 4 chart types: Summary Plot (feature importance with values), Decision Plot (cumulative SHAP paths), Bar Chart (mean absolute SHAP by class), and Force Plot (waterfall prediction breakdown).</p>
                                    </div>
                                </div>
                                
                                <div style="display: flex; align-items: start; gap: var(--space-12);">
                                    <div style="flex: 0 0 40px; height: 40px; background: #DB4545; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">5</div>
                                    <div style="flex: 1;">
                                        <h4 style="margin: 0 0 8px 0;">Interactive Dashboard</h4>
                                        <p style="margin: 0; color: var(--color-text-secondary);">Users navigate through experiments, view run details across multiple tabs (Overview, Metrics, Artifacts, SHAP Analysis), compare experiments side-by-side, and analyze fairness metrics when available.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- API Endpoints Used -->
                <div class="card" style="margin-top: var(--space-24);">
                    <div class="card__body">
                        <h3>üì° MLflow API Endpoints</h3>
                        <div class="table-container">
                            <table class="experiments-table">
                                <thead>
                                    <tr>
                                        <th>Endpoint</th>
                                        <th>Method</th>
                                        <th>Purpose</th>
                                        <th>Usage</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><code>/api/2.0/mlflow/experiments/search</code></td>
                                        <td><span class="status-badge finished">POST</span></td>
                                        <td>List all experiments</td>
                                        <td>Load experiments table, populate dropdowns</td>
                                    </tr>
                                    <tr>
                                        <td><code>/api/2.0/mlflow/runs/search</code></td>
                                        <td><span class="status-badge finished">POST</span></td>
                                        <td>Get runs for experiment</td>
                                        <td>Show experiment details, list all runs</td>
                                    </tr>
                                    <tr>
                                        <td><code>/api/2.0/mlflow/runs/get</code></td>
                                        <td><span class="status-badge running">GET</span></td>
                                        <td>Get specific run details</td>
                                        <td>Load run overview, metrics, parameters, tags</td>
                                    </tr>
                                    <tr>
                                        <td><code>/api/2.0/mlflow/artifacts/list</code></td>
                                        <td><span class="status-badge running">GET</span></td>
                                        <td>List artifacts for run</td>
                                        <td>Display artifact tree, enable downloads</td>
                                    </tr>
                                    <tr>
                                        <td><code>/get-artifact</code></td>
                                        <td><span class="status-badge running">GET</span></td>
                                        <td>Download artifact file</td>
                                        <td>Preview images, download models</td>
                                    </tr>
                                    <tr>
                                        <td><code>/artifact-content</code></td>
                                        <td><span class="status-badge running">GET</span></td>
                                        <td>Fetch artifact content</td>
                                        <td>Load SHAP CSVs for analysis</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Models View -->
        <div id="models-view" class="view">
            <div class="page-header">
                <h2>Coming Soon...</h2>
            </div>
        </div>

        <!-- Experiments View -->
        <div id="experiments-view" class="view">
            <div class="page-header">
                <h2>Experiments</h2>
            </div>

            <div class="model-run-section">
                <div class="card">
                    <div class="card__body">
                        <div class="filters-grid">
                            <div class="filters-group">
                                <label class="form-label">Select Model Type</label>
                                <select class="form-control" id="model-filter">
                                    <option value="">-- Select a Model --</option>
                                    <option value="Regression_LinearRegression">Linear Regression</option>
                                    <option value="Regression_GBTRegressor">GBT Regressor</option>
                                    <option value="Regression_RandomForest">Random Forest (Regression)</option>
                                    <option value="Regression_DecisionTree">Decision Tree (Regression)</option>
                                    <option value="Clustering_BisectingKMeans">Bisecting KMeans</option>
                                    <option value="Clustering_GaussianMixture">Gaussian Mixture</option>
                                    <option value="Clustering_LDA">Latent Dirichlet Allocation</option>
                                    <option value="Clustering_KMeans">KMeans</option>
                                    <option value="Classification_LogisticRegression">Logistic Regression</option>
                                    <option value="Classification_DecisionTree">Decision Tree</option>
                                    <option value="Classification_RandomForest">Random Forest (Classification)</option>
                                    <option value="Classification_GBTClassifier">GBT Classifier</option>
                                    <option value="Classification_LinearSVC">Linear SVC Classifier</option>
                                    <option value="Classification_MLPC">Multilayer Perceptron Classifier</option>
                                    <option value="Classification_NaiveBayes">Naive Bayes Classifier</option>
                                    <option value="Classification_OVR">One Vs Rest Classifier</option>
                                </select>
                            </div>
                            <div class="filter-group" style="max-width: 150px; display: flex; align-items: flex-end; margin-top: 25px;">
                                <button class="btn btn--primary" onclick="runModel()" disabled style="width: 100%; opacity: 0.5; cursor: not-allowed;">
                                    üöÄ Run Model
                                </button>
                            </div>
                        </div>
                        <!-- <input type="file" id="model-file-input" accept=".csv" class="model-file-input"> -->
                         <div class="form-group" style="margin-top: 20px;">
                            <label class="form-label">Upload Dataset (CSV)</label>
                            <input type="file" id="model-file-input" accept=".csv" class="form-control">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Experiments Table -->
            <div class="card" style="margin-top: 20px;">
                <div class="card__body">
                    <div class="table-container">
                        <table class="experiments-table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="experiments-tbody">
                                <!-- Will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Experiment Detail View -->
        <div id="experiment-detail-view" class="view">
    <div class="page-header">
        <button class="btn btn--outline" onclick="showView('experiments')">‚Üê Back to Experiments</button>
        <h2 id="experiment-detail-title">Experiment Details</h2>
    </div>

    <!-- Tab Navigation -->
    <div class="tabs" id="experiment-tabs-container" style="margin-bottom: 20px;">
        <button class="feature-tab active" onclick="switchExperimentDetailTab('runs')">Runs</button>
        <button class="feature-tab" onclick="switchExperimentDetailTab('comparison')">Comparison</button>
    </div>

    <!-- Runs Tab Content -->
    <div id="runs-tab-content" class="feature-tab-content active">
        <div class="experiment-detail-content" id="experiment-detail-content">
            <!-- Will be populated by JavaScript -->
        </div>
    </div>

    <!-- Comparison Tab Content -->
    <div id="comparison-tab-content" class="feature-tab-content">
        <div id="experiment-comparison-content">
            <!-- Will be populated by JavaScript -->
        </div>
    </div>
</div>

        <!-- Run Detail View -->
        <div id="run-detail-view" class="view">
            <div class="page-header">
                <button class="btn btn--outline" onclick="showView('experiment-detail')">‚Üê Back to Experiment</button>
                <h2 id="run-detail-title">Run Details</h2>
            </div>

            <div class="tabs">
                <button class="feature-tab active" onclick="switchRunTab('overview')">Overview</button>
                <button class="feature-tab" onclick="switchRunTab('metrics')">Model metrics</button>
                <button class="feature-tab" onclick="switchRunTab('artifacts')">Artifacts</button>
                <!-- New tab button -->
                <button class="feature-tab" onclick="switchRunTab('shap')">SHAP Analysis</button>
            </div>

            <div class="tab-contents">
                <div id="run-overview-tab" class="feature-tab-content active"></div>
                <div id="run-metrics-tab" class="feature-tab-content"></div>
                <div id="run-artifacts-tab" class="feature-tab-content"></div>
                <!-- New tab content -->
                <div id="run-shap-tab" class="feature-tab-content">
                    <div class="card">
                        <div class="card__body">
                            <h3>SHAP Analysis (from artifact CSV)</h3>
                            <p style="color: var(--color-text-secondary);">Auto-detected CSV artifact is used to render the charts.</p>
                        </div>
                    </div>

                    <!-- Visualizations grid: Summary, Decision, Bar -->
                    <div class="shap-visualizations" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
                        <div class="card" style="height: 100%;">
                            <div class="card__body" style="height: 100%; display: flex; flex-direction: column;">
                                <h3>üéØ SHAP Summary Plot</h3>
                                <div class="chart-container" style="position: relative; flex: 1; min-height: 420px;">
                                    <canvas id="run-shap-summary-chart"></canvas>
                                </div>
                            </div>
                        </div>

                        <div style="display: flex; flex-direction: column; gap: 20px; height: 100%;">
                            <div class="card" style="flex: 1;">
                                <div class="card__body" style="height: 100%; display: flex; flex-direction: column;">
                                    <h3>üíß SHAP Decision Plot</h3>
                                    <div class="chart-container" style="position: relative; flex: 1; min-height: 300px;">
                                        <canvas id="run-shap-decision-chart"></canvas>
                                    </div>
                                </div>
                            </div>

                            <div class="card" style="flex: 1;">
                                <div class="card__body" style="height: 100%; display: flex; flex-direction: column;">
                                    <h3>üìä SHAP Bar Chart</h3>
                                    <div class="chart-container" style="position: relative; flex: 1; min-height: 300px;">
                                        <canvas id="run-shap-bar-chart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Force plot -->
                    <div class="card" style="margin-top: 20px;">
                        <div class="card__body">
                            <h3>üíß SHAP Force Plot</h3>
                            <div class="chart-container" style="position: relative; min-height: 140px;">
                                <canvas id="run-shap-force-chart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- SHAP Values Table -->
                    <div class="card">
                        <div class="card__body">
                            <h3>üìã SHAP Values Details</h3>
                            <div class="table-container">
                                <table class="shap-values-table" id="run-shap-values-table">
                                    <thead>
                                        <tr>
                                            <th>Feature</th>
                                            <th>SHAP Value</th>
                                            <th>Feature Value</th>
                                            <th>Contribution</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Populated dynamically -->
                                    </tbody>
                                </table>
                            </div>
                            <div id="run-shap-status" style="margin-top: 8px; color: var(--color-text-secondary);"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Comparison View -->
        <div id="comparison-view" class="view">
            <div class="page-header">
                <div style="display: flex; gap: 16px; align-items: center; width: 100%;">
                <button class="btn btn--outline" onclick="showView('experiments')">‚Üê Back to Experiments</button>
                <h2 style="flex: 1; margin: 0;">Experiment Comparison</h2>
                <button class="btn btn--primary" onclick="generatePDFReport()" title="Generate PDF report of selected experiments">
                    üìÑ Generate PDF Report
                </button>
                </div>
            </div>

            <div id="comparison-content"></div>
        </div>
    </main>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="app.js"></script>
    <script>
// Function to switch between tabs in experiment detail view
function switchExperimentDetailTab(tabName) {
    // Hide all tab contents
    document.querySelectorAll('#experiment-detail-view .feature-tab-content').forEach(el => {
        el.classList.remove('active');
    });

    // Show selected tab content
    const tabContent = document.getElementById(`${tabName}-tab-content`);
    if (tabContent) {
        tabContent.classList.add('active');
        
        // If comparison tab is clicked, render the comparison
        if (tabName === 'comparison') {
            renderExperimentRunsComparison(window.currentExperimentId, window.currentExperimentRuns);
        }
    }

    // Update tab button active state
    document.querySelectorAll('#experiment-detail-view .feature-tab').forEach(btn => {
        btn.classList.remove('active');
    });
    
    const activeBtn = Array.from(document.querySelectorAll('#experiment-detail-view .feature-tab'))
        .find(b => {
            const text = b.textContent.toLowerCase().trim();
            return text === tabName.toLowerCase();
        });
    if (activeBtn) {
        activeBtn.classList.add('active');
    }
}

// Update showExperimentDetail to populate the runs tab
async function showExperimentDetail(experiment) {
    const runs = await getExperimentDetailsFromAPI(experiment.experiment_id);
    console.log("Runs: ", runs)

    if (!runs) {
        console.error('Experiment not found:', experiment.experiment_id);
        return;
    }
    
    document.getElementById('experiment-detail-title').textContent = experiment.name;
    
    const content = document.getElementById('experiment-detail-content');
    content.innerHTML = `
        <div class="detail-section" style="margin-top: var(--space-32);">
            <h3>Runs (${runs.length})</h3>
            ${runs.length === 0 ? `
                <p style="color: var(--color-text-secondary); padding: var(--space-24); text-align: center;">
                    No runs found for this experiment
                </p>
            ` : `
                <div class="card">
                    <div class="card__body">
                        <div class="table-container">
                            <table class="experiments-table">
                                <thead>
                                    <tr>
                                        <th>Run Name</th>
                                        <th>Source</th>
                                        <th>Status</th>
                                        <th>Model Type</th>
                                        <th>Dataset Level</th>
                                        <th>User</th>
                                        <th>Accuracy</th>
                                        <th>Duration</th>
                                        <th>Start Time</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${runs.map((run) => {
                                        const metricsMap = Object.fromEntries(
                                            (run.data.metrics || []).map(m => [m.key, m.value])
                                        );
                                        return `
                                        <tr>
                                            <td>
                                                <a href="#" class="experiment-name" onclick="showRunDetail('${run.info.run_id}'); return false;">
                                                    ${run.info.run_name}
                                                </a>
                                            </td>
                                            <td>${run.data.tags && run.data.tags[2] ? run.data.tags[2].value : '--'}</td>
                                            <td>
                                                <span class="status-badge ${run.info.status.toLowerCase()}">${run.info.status}</span>
                                            </td>
                                            <td>${run.data.params && run.data.params[0] ? run.data.params[0].value : '--'}</td>
                                            <td>${run.data.params && run.data.params[1] ? run.data.params[1].value : '--'}</td>
                                            <td>${run.info.user_id}</td>
                                            <td>${metricsMap.accuracy ? (metricsMap.accuracy * 100).toFixed(1) + '%' : 'N/A'}</td>
                                            <td>${((run.info.end_time-run.info.start_time) / 1000).toFixed(1)}s</td>
                                            <td>${new Date(run.info.start_time).toLocaleString()}</td>
                                            <td>
                                                <button class="btn btn--sm btn--outline" onclick="showRunDetail('${run.info.run_id}')">
                                                    View Details
                                                </button>
                                            </td>
                                        </tr>
                                    `}).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `}
        </div>
    `;
    
    showView('experiment-detail');

    // Store experiment ID and runs for comparison
    window.currentExperimentId = experiment.experiment_id;
    window.currentExperimentRuns = runs;
}

// Function to render comparison of all runs in an experiment
function renderExperimentRunsComparison(experimentId, runs) {
    const container = document.getElementById('experiment-comparison-content');
    if (!container || !runs) {
        console.error('Container or runs not found');
        return;
    }

    const finishedRuns = runs.filter(r => r.info.status === 'FINISHED');

    if (finishedRuns.length < 2) {
        container.innerHTML = `
            <div class="card">
                <div class="card__body">
                    <p style="text-align: center; color: var(--color-text-secondary);">
                        Need at least 2 finished runs to compare. Current finished runs: ${finishedRuns.length}
                    </p>
                </div>
            </div>
        `;
        return;
    }

    // Dynamically detect available metrics from all runs
    const availableMetrics = new Set();
    finishedRuns.forEach(run => {
        (run.data.metrics || []).forEach(m => {
            availableMetrics.add(m.key);
        });
    });

    // Convert Set to sorted array
    const metrics = Array.from(availableMetrics).sort();

    if (metrics.length === 0) {
        container.innerHTML = `
            <div class="card">
                <div class="card__body">
                    <p style="text-align: center; color: var(--color-text-secondary);">
                        No metrics found in the runs.
                    </p>
                </div>
            </div>
        `;
        return;
    }

    // Detect problem type based on available metrics
    const problemType = detectProblemType(metrics);
    
    console.log('Available Metrics:', metrics);
    console.log('Detected Problem Type:', problemType);
    
    // Helper to get metric value
    const getMetricValue = (run, metricName) => {
        const metric = run.data.metrics?.find(m => m.key === metricName);
        return metric ? metric.value : null;
    };

    // Build metrics comparison table
    let metricsHTML = '<div class="table-container"><table class="experiments-table"><thead><tr><th style="min-width: 150px;">Metric</th>';
    metricsHTML += finishedRuns.map(run => `<th style="text-align: center;">${run.info.run_name}</th>`).join('');
    metricsHTML += '</tr></thead><tbody>';

    metrics.forEach(metric => {
        metricsHTML += '<tr>';
        metricsHTML += `<td style="font-weight: 600;">${formatMetricName(metric)}</td>`;
        
        const metricValues = finishedRuns.map(run => getMetricValue(run, metric));
        const validValues = metricValues.filter(v => v !== null && !isNaN(v));
        
        // For metrics that should be minimized (like loss, error), find min instead of max
        let bestValue = null;
        if (validValues.length > 0) {
            const shouldMinimize = shouldMinimizeMetric(metric);
            bestValue = shouldMinimize ? 
                Math.min(...validValues) : 
                Math.max(...validValues);
        }
        
        metricsHTML += metricValues.map(val => {
            const isBest = val !== null && val === bestValue;
            const displayVal = formatMetricValue(val, metric);
            const bgColor = isBest ? 'background-color: rgba(31, 184, 205, 0.2);' : '';
            return `<td style="text-align: center; padding: 12px; ${bgColor}${isBest ? 'font-weight: bold;' : ''}">${displayVal}</td>`;
        }).join('');
        
        metricsHTML += '</tr>';
    });

    metricsHTML += '</tbody></table></div>';

    // Get all unique parameters
    const allParams = new Set();
    finishedRuns.forEach(run => {
        (run.data.params || []).forEach(p => allParams.add(p.key));
    });

    let paramsHTML = '';
    if (allParams.size > 0) {
        paramsHTML = '<div class="table-container"><table class="experiments-table"><thead><tr><th style="min-width: 150px;">Parameter</th>';
        paramsHTML += finishedRuns.map(run => `<th style="text-align: center;">${run.info.run_name}</th>`).join('');
        paramsHTML += '</tr></thead><tbody>';

        Array.from(allParams).forEach(paramKey => {
            paramsHTML += '<tr>';
            paramsHTML += `<td style="font-weight: 600;">${paramKey}</td>`;
            paramsHTML += finishedRuns.map(run => {
                const param = run.data.params?.find(p => p.key === paramKey);
                return `<td style="text-align: center; padding: 12px;">${param ? param.value : '-'}</td>`;
            }).join('');
            paramsHTML += '</tr>';
        });

        paramsHTML += '</tbody></table></div>';
    }

    // Build overview cards
    let overviewHTML = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">';
    
    finishedRuns.forEach(run => {
        const metricsMap = Object.fromEntries(
            (run.data.metrics || []).map(m => [m.key, m.value])
        );
        const duration = ((run.info.end_time - run.info.start_time) / 1000).toFixed(1);
        
        // Get primary metric based on problem type
        const primaryMetric = getPrimaryMetric(metrics, problemType);
        const primaryValue = metricsMap[primaryMetric];
        
        overviewHTML += `
            <div class="card" style="cursor: pointer; transition: box-shadow 0.2s;" onclick="showRunDetail('${run.info.run_id}')">
                <div class="card__body">
                    <h4 style="margin-top: 0; color: #1FB8CD;">${run.info.run_name}</h4>
                    <div style="font-size: 13px;">
                        <p style="margin: 6px 0;"><strong>Status:</strong> <span class="status-badge ${run.info.status.toLowerCase()}">${run.info.status}</span></p>
                        <p style="margin: 6px 0;"><strong>${formatMetricName(primaryMetric)}:</strong> ${formatMetricValue(primaryValue, primaryMetric)}</p>
                        <p style="margin: 6px 0;"><strong>Duration:</strong> ${duration}s</p>
                        <p style="margin: 6px 0;"><strong>User:</strong> ${run.info.user_id || 'N/A'}</p>
                    </div>
                    <button class="btn btn--sm btn--primary" style="margin-top: 12px;">View Full Details</button>
                </div>
            </div>
        `;
    });
    
    overviewHTML += '</div>';

    // Create comparison chart
    const chartId = `experiment-comparison-chart-${experimentId}`;

    let chartHTML = `
        <div class="card" style="margin-top: 20px;">
            <div class="card__body">
                <h3>üìä Metrics Comparison Chart</h3>
                <div style="position: relative; height: 400px; margin-top: 20px;">
                    <canvas id="${chartId}"></canvas>
                </div>
            </div>
        </div>
    `;

    container.innerHTML = `
        <div style="margin-bottom: 20px;">
            <div class="card" style="background: linear-gradient(135deg, #1FB8CD 0%, #17a8be 100%); color: white;">
                <div class="card__body">
                    <h3 style="margin-top: 0;">üîç Problem Type: <span style="text-transform: capitalize; font-weight: 600;">${problemType}</span></h3>
                    <p style="margin: 8px 0; opacity: 0.9;">Comparing ${finishedRuns.length} runs with ${metrics.length} detected metrics</p>
                </div>
            </div>
        </div>

        ${overviewHTML}
        
        <div class="card">
            <div class="card__body">
                <h3>üìã Metrics Comparison</h3>
                ${metricsHTML}
                <p style="font-size: 12px; color: #666; margin-top: 12px;"><em>Highlighted cells show the best value for each metric</em></p>
            </div>
        </div>

        ${allParams.size > 0 ? `
            <div class="card" style="margin-top: 20px;">
                <div class="card__body">
                    <h3>‚öôÔ∏è Parameters Comparison</h3>
                    ${paramsHTML}
                </div>
            </div>
        ` : ''}

        ${chartHTML}
    `;

    // Create chart after a small delay to ensure canvas is rendered
    setTimeout(() => {
        createExperimentRunsComparisonChart(chartId, finishedRuns, metrics, problemType);
    }, 100);
}

function detectProblemType(metrics) {
    const metricsStr = metrics.join(',').toLowerCase();
    
    // Classification metrics
    const classificationMetrics = ['accuracy', 'precision', 'recall', 'f1_score', 'auc_roc', 'confusion_matrix', 'roc_auc'];
    const isClassification = classificationMetrics.some(m => metricsStr.includes(m));
    
    // Regression metrics
    const regressionMetrics = ['mse', 'rmse', 'mae', 'mape', 'r2_score', 'r_squared'];
    const isRegression = regressionMetrics.some(m => metricsStr.includes(m));
    
    // Clustering metrics
    const clusteringMetrics = ['silhouette_score', 'davies_bouldin_score', 'calinski_harabasz_score', 'inertia'];
    const isClustering = clusteringMetrics.some(m => metricsStr.includes(m));
    
    if (isClassification) return 'classification';
    if (isRegression) return 'regression';
    if (isClustering) return 'clustering';
    
    return 'unknown';
}

function getPrimaryMetric(metrics, problemType) {
    const metricsArray = Array.from(metrics);
    
    if (problemType === 'classification') {
        if (metricsArray.includes('accuracy')) return 'accuracy';
        if (metricsArray.includes('f1_score')) return 'f1_score';
        if (metricsArray.includes('auc_roc')) return 'auc_roc';
    } else if (problemType === 'regression') {
        if (metricsArray.includes('r2_score')) return 'r2_score';
        if (metricsArray.includes('r_squared')) return 'r_squared';
        if (metricsArray.includes('rmse')) return 'rmse';
        if (metricsArray.includes('mse')) return 'mse';
    } else if (problemType === 'clustering') {
        if (metricsArray.includes('silhouette_score')) return 'silhouette_score';
        if (metricsArray.includes('davies_bouldin_score')) return 'davies_bouldin_score';
    }
    
    // Fallback to first metric
    return metricsArray[0];
}

function shouldMinimizeMetric(metric) {
    const metricsToMinimize = [
        'loss', 'mse', 'rmse', 'mae', 'mape', 'error',
        'davies_bouldin_score', 'inertia'
    ];
    return metricsToMinimize.some(m => metric.toLowerCase().includes(m));
}

// Format metric name for display
function formatMetricName(metricKey) {
    return metricKey
        .replace(/_/g, ' ')
        .split(' ')
        .map(word => word.charAt(0).toUpperCase() + word.slice(1))
        .join(' ');
}

// Format metric value for display
function formatMetricValue(value, metricKey) {
    if (value === null || value === undefined) {
        return 'N/A';
    }
    
    // Check if it's a percentage metric
    const percentageMetrics = ['accuracy', 'precision', 'recall', 'f1_score', 'auc_roc', 'silhouette_score'];
    const isPercentage = percentageMetrics.some(m => metricKey.toLowerCase().includes(m));
    
    const numValue = parseFloat(value);
    
    if (isNaN(numValue)) {
        return value;
    }
    
    // If value is between 0 and 1 and is a percentage metric, show as percentage
    if (isPercentage && numValue >= 0 && numValue <= 1) {
        return (numValue * 100).toFixed(2) + '%';
    }
    
    // Otherwise show with 4 decimal places for precision
    return numValue.toFixed(4);
}

// Function to create radar chart for runs comparison
function createExperimentRunsComparisonChart(canvasId, runs, metrics, problemType) {
    const ctx = document.getElementById(canvasId);
    if (!ctx) {
        console.error('Canvas not found:', canvasId);
        return;
    }

    // Helper to get metric value as normalized percentage
    const getMetricValue = (run, metricName) => {
        const metric = run.data.metrics?.find(m => m.key === metricName);
        if (!metric) return 0;
        
        let value = metric.value;
        
        // Normalize value to 0-100 scale
        if (value >= 0 && value <= 1) {
            return value * 100;
        }
        
        // For metrics that might be larger, cap at 100 or normalize
        if (value > 100) {
            return Math.min(value, 100);
        }
        
        return value;
    };

    // Select top metrics to display (limit to 6 for readability)
    const displayMetrics = metrics.slice(0, 6);

    // Prepare datasets for each run
    const datasets = runs.map((run, index) => {
        const colors = ['#1FB8CD', '#FFC185', '#B4413C', '#ECEBD5', '#5D878F'];
        const color = colors[index % colors.length];

        return {
            label: run.info.run_name,
            data: displayMetrics.map(metric => getMetricValue(run, metric)),
            borderColor: color,
            backgroundColor: color + '33',
            borderWidth: 2,
            fill: true,
            pointRadius: 5,
            pointHoverRadius: 7,
            pointBackgroundColor: color,
            pointBorderColor: '#fff',
            pointBorderWidth: 2
        };
    });

    // Destroy existing chart if it exists
    if (window.experimentRunsCharts && window.experimentRunsCharts[canvasId]) {
        window.experimentRunsCharts[canvasId].destroy();
    }

    if (!window.experimentRunsCharts) {
        window.experimentRunsCharts = {};
    }

    // Choose chart type based on problem type
    const chartType = displayMetrics.length > 3 ? 'radar' : 'bar';

    const chartConfig = {
        type: chartType,
        data: {
            labels: displayMetrics.map(m => formatMetricName(m)),
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: chartType === 'bar' ? {
                y: {
                    beginAtZero: true,
                    max: 100,
                    ticks: {
                        callback: function(value) {
                            return value + '%';
                        }
                    }
                }
            } : {
                r: {
                    beginAtZero: true,
                    max: 100,
                    ticks: {
                        callback: function(value) {
                            return value + '%';
                        }
                    },
                    grid: {
                        color: 'rgba(0, 0, 0, 0.1)'
                    }
                }
            },
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        font: { size: 12 },
                        padding: 15
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.dataset.label + ': ' + context.parsed.y.toFixed(2) + '%';
                        }
                    }
                }
            }
        }
    };

    // Create new chart
    window.experimentRunsCharts[canvasId] = new Chart(ctx, chartConfig);
}

</script>
</body>
</html>